<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>JSE Sentiment Analysis</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1 {
      margin-bottom: 10px;
    }
    input {
      margin-right: 5px;
    }
    #errorMessage {
      margin-top: 10px;
      font-weight: bold;
    }
    #currentPriceDisplay {
      margin-top: 5px;
    }

    table {
      margin-top: 15px;
      border-collapse: collapse;
      width: 100%;
      max-width: 700px;
    }
    table thead {
      background-color: #f4f4f4;
    }
    table th, table td {
      padding: 8px 12px;
      text-align: center;
      vertical-align: middle; /* helps keep arrow/ticker aligned */
      border-bottom: 1px solid #ccc;
    }
    table th {
      border-bottom: 2px solid #ccc;
    }

    /* A container for the chart */
    .chart-container {
      width: 100%;
      position: relative;
      margin-top: 10px;
      padding: 15px;
      background-color: #f9f9f9;
      border: 1px solid #ccc;
      min-height: 150px; /* extra space so labels/titles don’t overlap */
    }
    .chart-title {
      font-weight: bold;
      text-align: center;
      /* Give extra space below the title so the average label doesn’t overlap */
      margin-bottom: 30px;
    }

    /* The horizontal "track" for price targets (styled like Yahoo's) */
    .price-range-track {
      position: relative;
      height: 8px;
      background-color: #ccc;
      border-radius: 4px;
      /* margin-top: 10px so it’s well below the chart-title */
      margin: 10px auto 15px auto;
      z-index: 1;
    }

    /* Each "dot" on the track */
    .price-dot {
      position: absolute;
      top: 50%;
      width: 10px;
      height: 10px;
      background-color: #666;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      z-index: 2;
    }

    /* Label that pops above each dot */
    .price-label {
      position: absolute;
      transform: translate(-50%, -140%);
      background-color: #fff;
      border: 1px solid #aaa;
      border-radius: 3px;
      padding: 3px 5px;
      font-size: 13px;
      white-space: nowrap;
      z-index: 3;
    }

    /* Emphasize the current price dot */
    .price-dot.current {
      background-color: #d00;
    }
    .price-label.current {
      color: #d00;
      border-color: #d00;
      font-weight: bold;
    }

    /* So the chart "row" is hidden by default */
    .chartRow {
      display: none;
    }

    /* We want a pointer cursor on the main row to show it’s clickable */
    .clickable-row {
      cursor: pointer;
    }

    /* Arrow icon absolutely positioned so it’s truly on the far left */
    .arrow-cell {
      text-align: left;
      position: relative;
    }
    .arrow-icon {
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      font-weight: bold;
    }
    /* A span to hold the ticker text with left margin so it doesn’t collide with arrow */
    .ticker-text {
      margin-left: 25px;  /* space to the right of arrow */
    }
  </style>
</head>
<body>

  <h1>JSE Sentiment Analysis</h1>

  <!-- Inputs for ticker + price prediction -->
  <input type="text" id="tickerInput" placeholder="Enter Stock Ticker (e.g. ECL)" />
  <input type="number" id="priceInput" placeholder="1-Year Price Prediction ($)" />
  <button id="submitPrediction">Submit Prediction</button>

  <p id="errorMessage"></p>
  <p id="currentPriceDisplay"></p>

  <table id="predictionsTable">
    <thead>
      <tr>
        <th>Ticker</th>
        <th>Current Price ($)</th>
        <th>Avg Prediction Price ($)</th>
        <th>Potential Upside/Downside (%)</th>
        <th>Prediction Count</th>
      </tr>
    </thead>
    <tbody id="predictionsBody"></tbody>
  </table>

  <!-- 
    1) Firebase v9 "modular" SDK from CDN.
    2) Must be served via HTTPS (GitHub Pages does).
  -->
  <script type="module">
    /***************************************************
     * STEP A: Import Firebase v9 modules
     ***************************************************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-analytics.js";
    import { getDatabase, ref, onValue, push } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    /***************************************************
     * STEP B: Your Firebase config
     ***************************************************/
    const firebaseConfig = {
      apiKey: "AIzaSyAp2QQErI9LtACfXuktlX-5847Rt8JWPfM",
      authDomain: "jse-sentiment-analysis.firebaseapp.com",
      databaseURL: "https://jse-sentiment-analysis-default-rtdb.firebaseio.com",
      projectId: "jse-sentiment-analysis",
      storageBucket: "jse-sentiment-analysis.appspot.com",
      messagingSenderId: "225282121975",
      appId: "1:225282121975:web:29bd14c63a4c11fc66b3f2",
      measurementId: "G-VLGXC41LME"
    };
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    getAnalytics(app);
    const db = getDatabase(app);

    /***************************************************
     * STEP C: Load tickers from GitHub
     ***************************************************/
    const tickersUrl = "https://raw.githubusercontent.com/matthewpres/JSE-Sentiment/main/tickers.json";
    let stockPrices = {};

    fetch(tickersUrl)
      .then(res => res.json())
      .then(data => {
        stockPrices = data;
        console.log("Loaded stock prices:", data);
        updateAutocomplete();
      })
      .catch(err => console.error("Error loading tickers:", err));

    function updateAutocomplete() {
      const tickerInput = document.getElementById("tickerInput");
      const datalist = document.createElement("datalist");
      datalist.id = "tickerList";

      Object.keys(stockPrices).forEach(ticker => {
        let option = document.createElement("option");
        option.value = ticker;
        datalist.appendChild(option);
      });

      tickerInput.setAttribute("list", "tickerList");
      document.body.appendChild(datalist);
    }

    /***************************************************
     * STEP D: Listen to Realtime Database: /predictions
     ***************************************************/
    const predictionsRef = ref(db, "predictions");
    onValue(predictionsRef, (snapshot) => {
      const data = snapshot.val() || {};
      // Convert { TICKER: {key1:{price}, ...}, ... } -> { TICKER: [price1, price2, ...], ... }
      let predictionsMap = {};

      Object.keys(data).forEach(ticker => {
        let entries = data[ticker];
        let priceArray = Object.keys(entries).map(k => entries[k].price);
        predictionsMap[ticker] = priceArray;
      });

      // Re-render the table with the updated predictions
      renderPredictionTable(predictionsMap);
    });

    /***************************************************
     * STEP E: Submitting a new prediction
     ***************************************************/
    document.getElementById("submitPrediction").addEventListener("click", () => {
      const ticker = document.getElementById("tickerInput").value.toUpperCase();
      const predictionPrice = parseFloat(document.getElementById("priceInput").value);
      const errorMessageEl = document.getElementById("errorMessage");

      if (!ticker || isNaN(predictionPrice) || !(ticker in stockPrices)) {
        errorMessageEl.textContent = "Invalid ticker or missing price.";
        errorMessageEl.style.color = "red";
        return;
      }

      // Push to /predictions/<TICKER>
      const tickerRef = ref(db, "predictions/" + ticker);
      push(tickerRef, {
        price: predictionPrice,
        timestamp: Date.now()
      })
      .then(() => {
        errorMessageEl.textContent = "Prediction submitted successfully!";
        errorMessageEl.style.color = "green";
        document.getElementById("tickerInput").value = "";
        document.getElementById("priceInput").value = "";
      })
      .catch(err => {
        console.error("Error submitting prediction:", err);
        errorMessageEl.textContent = "Error submitting prediction.";
        errorMessageEl.style.color = "red";
      });
    });

    /***************************************************
     * STEP F: Render the table
     ***************************************************/
    function renderPredictionTable(predictionsMap) {
      const predictionsBody = document.getElementById("predictionsBody");
      predictionsBody.innerHTML = "";

      Object.keys(predictionsMap).forEach(ticker => {
        let priceArray = predictionsMap[ticker];
        let avgPredictionPrice = priceArray.reduce((a, b) => a + b, 0) / priceArray.length;

        let currentPrice = stockPrices[ticker] || "N/A";
        let potentialMove = "N/A";
        if (currentPrice !== "N/A") {
          potentialMove = ((avgPredictionPrice - currentPrice) / currentPrice) * 100;
        }

        // Create the main row (clickable)
        let row = document.createElement("tr");
        row.classList.add("clickable-row");

        // The first cell has arrow + ticker
        let arrowCell = document.createElement("td");
        arrowCell.classList.add("arrow-cell");
        arrowCell.innerHTML = `
          <span class="arrow-icon">&#x25BC;</span>
          <span class="ticker-text">${ticker}</span>
        `;

        // The other cells
        let currentPriceCell = document.createElement("td");
        currentPriceCell.textContent = (currentPrice !== "N/A") 
          ? "$" + currentPrice.toFixed(2)
          : "N/A";

        let avgCell = document.createElement("td");
        avgCell.textContent = `$${avgPredictionPrice.toFixed(2)}`;

        let upsideCell = document.createElement("td");
        upsideCell.textContent = (potentialMove !== "N/A")
          ? potentialMove.toFixed(2) + "%"
          : "N/A";

        let countCell = document.createElement("td");
        countCell.textContent = priceArray.length;

        // Append cells to the row
        row.appendChild(arrowCell);
        row.appendChild(currentPriceCell);
        row.appendChild(avgCell);
        row.appendChild(upsideCell);
        row.appendChild(countCell);

        // Second row to hold the chart; hidden by default
        let chartRow = document.createElement("tr");
        chartRow.classList.add("chartRow");
        let chartCell = document.createElement("td");
        chartCell.colSpan = 5; // span all columns
        chartCell.innerHTML = `<div class="chart-container"></div>`;
        chartRow.appendChild(chartCell);

        // On main row click, toggle the chart row
        row.addEventListener("click", () => {
          const arrowIcon = arrowCell.querySelector(".arrow-icon");
          if (chartRow.style.display === "table-row") {
            chartRow.style.display = "none";
            arrowIcon.textContent = "▼";
          } else {
            chartRow.style.display = "table-row";
            arrowIcon.textContent = "▲";

            // Render the chart in the chart container
            let containerDiv = chartCell.querySelector(".chart-container");
            containerDiv.innerHTML = ""; // clear old contents
            containerDiv.appendChild(
              renderPriceTargetChart(ticker, priceArray, currentPrice)
            );
          }
        });

        predictionsBody.appendChild(row);
        predictionsBody.appendChild(chartRow);
      });
    }

    function showCurrentPrice(ticker) {
      const price = stockPrices[ticker];
      document.getElementById("currentPriceDisplay").textContent =
        price !== undefined
          ? `Current Market Price: $${price.toFixed(2)}`
          : "Market price not available";
    }

    /***************************************************
     * STEP G: Build a "Yahoo-like" price target chart
     ***************************************************/
    function renderPriceTargetChart(ticker, predictions, currentPrice) {
      let minPrice = Math.min(...predictions);
      let maxPrice = Math.max(...predictions);
      let avgPrice = predictions.reduce((a, b) => a + b, 0) / predictions.length;

      // Avoid divide-by-zero if all predictions are identical
      if (minPrice === maxPrice) {
        maxPrice = minPrice + 0.01;
      }

      // Convert a numeric price to a 0-100% offset
      function getPct(price) {
        let pct = ((price - minPrice) / (maxPrice - minPrice)) * 100;
        return Math.max(0, Math.min(100, pct));
      }

      let container = document.createElement("div");
      container.className = "chart-container";

      // Title
      let title = document.createElement("div");
      title.className = "chart-title";
      title.textContent = `Analyst Price Targets for ${ticker}`;
      container.appendChild(title);

      // The track
      let track = document.createElement("div");
      track.className = "price-range-track";
      container.appendChild(track);

      // Create & place dots for Low, Avg, High
      let lowPct = getPct(minPrice);
      let avgPct = getPct(avgPrice);
      let highPct = getPct(maxPrice);

      track.appendChild(createDot(lowPct, minPrice, "Low"));
      track.appendChild(createDot(avgPct, avgPrice, "Average"));
      track.appendChild(createDot(highPct, maxPrice, "High"));

      // Current
      if (currentPrice !== "N/A") {
        let currPct = getPct(currentPrice);
        let currentDot = createDot(currPct, currentPrice, "Current", true);
        track.appendChild(currentDot);

        // optional overlap hack:
        let diffToLow = Math.abs(currPct - lowPct);
        let diffToAvg = Math.abs(currPct - avgPct);
        let diffToHigh = Math.abs(currPct - highPct);
        if (diffToLow < 10 || diffToAvg < 10 || diffToHigh < 10) {
          let currentLabel = currentDot.querySelector(".price-label");
          // Raise label if too close
          currentLabel.style.transform = "translate(-50%, -220%)";
        }
      }
      return container;
    }

    /***************************************************
     * Helper: create a labeled dot
     ***************************************************/
    function createDot(percent, priceValue, labelText, isCurrent=false) {
      // Dot
      let dot = document.createElement("div");
      dot.className = "price-dot" + (isCurrent ? " current" : "");
      dot.style.left = percent + "%";

      // Label
      let label = document.createElement("div");
      label.className = "price-label" + (isCurrent ? " current" : "");
      label.textContent = `$${priceValue.toFixed(2)} (${labelText})`;
      label.style.left = percent + "%";

      // A container so we can absolutely position
      let fragment = document.createElement("div");
      fragment.style.position = "absolute";
      fragment.style.left = 0;
      fragment.style.right = 0;
      fragment.style.top = 0;

      fragment.appendChild(dot);
      fragment.appendChild(label);
      return fragment;
    }
  </script>
</body>
</html>
