<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>JSE Sentiment Analysis</title>
  <!-- You can remove Chart.js if you're not using it for other charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    input {
      margin-right: 5px;
    }

    table {
      margin-top: 15px;
      border-collapse: collapse;
      width: 100%;
      max-width: 600px;
    }
    table thead {
      background-color: #f4f4f4;
    }
    table th,
    table td {
      padding: 8px 12px;
      text-align: center;
    }
    table th {
      border-bottom: 2px solid #ccc;
    }
    table td {
      border-bottom: 1px solid #ccc;
    }

    .chart-container {
      width: 600px;
      margin: 40px auto;
    }

    #errorMessage {
      margin-top: 10px;
      font-weight: bold;
    }
    #currentPriceDisplay {
      margin-top: 5px;
    }

    /* The "number line" for price targets */
    .number-line {
      position: relative;
      width: 100%;
      height: 8px;
      background-color: #ccc;
      border-radius: 4px;
      margin-top: 20px;
    }

    /* Marker labels */
    .marker {
      position: absolute;
      top: -25px;
      transform: translateX(-50%);
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 3px;
      padding: 2px 4px;
      font-size: 14px;
      white-space: nowrap;
    }
    .marker-current {
      color: #d00;
      border-color: #d00;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>JSE Sentiment Analysis</h1>

  <input type="text" id="tickerInput" placeholder="Enter Stock Ticker (e.g. ECL)" />
  <input type="number" id="priceInput" placeholder="1-Year Price Prediction ($)" />
  <button id="submitPrediction">Submit Prediction</button>

  <p id="errorMessage"></p>
  <p id="currentPriceDisplay"></p>

  <table>
    <thead>
      <tr>
        <th>Ticker</th>
        <th>Current Price ($)</th>
        <th>Avg Prediction Price ($)</th>
        <th>Potential Upside/Downside (%)</th>
        <th>Prediction Count</th>
      </tr>
    </thead>
    <tbody id="predictionsBody"></tbody>
  </table>

  <div class="chart-container">
    <h3>Price Target Range</h3>
    <div id="priceTargetChart"></div>
  </div>

  <script>
    // 1) Load the stock prices from GitHub
    const tickersUrl = "https://raw.githubusercontent.com/matthewpres/JSE-Sentiment/main/tickers.json";
    let stockPrices = {};

    fetch(tickersUrl)
      .then(response => response.json())
      .then(data => {
        stockPrices = data;
        console.log("Stock prices loaded:", stockPrices);
        updateAutocomplete();
        // Once we have prices, also load existing predictions from server
        fetchPredictionsFromServer();
      })
      .catch(error => console.error("Error loading tickers:", error));

    // 2) Autocomplete for the ticker input
    function updateAutocomplete() {
      let tickerInput = document.getElementById("tickerInput");
      let datalist = document.createElement("datalist");
      datalist.id = "tickerList";

      Object.keys(stockPrices).forEach(ticker => {
        let option = document.createElement("option");
        option.value = ticker;
        datalist.appendChild(option);
      });

      tickerInput.setAttribute("list", "tickerList");
      document.body.appendChild(datalist);
    }

    // 3) On "Submit Prediction," POST to our server
    document.getElementById("submitPrediction").addEventListener("click", function () {
      const ticker = document.getElementById("tickerInput").value.toUpperCase();
      const predictionPrice = parseFloat(document.getElementById("priceInput").value);
      const errorMessageEl = document.getElementById("errorMessage");

      // Basic validation
      if (!ticker || isNaN(predictionPrice) || !(ticker in stockPrices)) {
        errorMessageEl.textContent = "Invalid ticker or missing price.";
        errorMessageEl.style.color = "red";
        return;
      }

      // POST the new prediction
      fetch("/api/predictions", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ticker, price: predictionPrice }),
      })
        .then(res => {
          if (!res.ok) {
            throw new Error("Server error while posting prediction");
          }
          return res.json();
        })
        .then(data => {
          // data = updated predictions from the server
          errorMessageEl.textContent = "Prediction submitted successfully!";
          errorMessageEl.style.color = "green";

          // Clear input
          document.getElementById("tickerInput").value = "";
          document.getElementById("priceInput").value = "";

          // Re-render the table with fresh data
          renderPredictionTable(data);
        })
        .catch(err => {
          errorMessageEl.textContent = err.message;
          errorMessageEl.style.color = "red";
        });
    });

    // 4) Get the existing predictions from the server
    function fetchPredictionsFromServer() {
      fetch("/api/predictions")
        .then(res => res.json())
        .then(data => {
          console.log("Loaded predictions:", data);
          renderPredictionTable(data);
        })
        .catch(err => {
          console.error("Error fetching predictions:", err);
        });
    }

    // 5) Render the table
    function renderPredictionTable(predictionsData) {
      let predictionsBody = document.getElementById("predictionsBody");
      predictionsBody.innerHTML = "";

      // predictionsData shape: { "TICKER": [prices...], "TICKER2": [...], ... }
      Object.keys(predictionsData).forEach(ticker => {
        let predictionPrices = predictionsData[ticker];
        // Calculate average
        let avgPredictionPrice =
          predictionPrices.reduce((a, b) => a + b, 0) / predictionPrices.length;

        let currentPrice = stockPrices[ticker] || "N/A";
        let potentialMove = "N/A";
        if (currentPrice !== "N/A") {
          potentialMove = ((avgPredictionPrice - currentPrice) / currentPrice) * 100;
        }

        let row = document.createElement("tr");
        row.innerHTML = `
          <td>${ticker}</td>
          <td>${currentPrice !== "N/A" ? "$" + currentPrice.toFixed(2) : "N/A"}</td>
          <td>$${avgPredictionPrice.toFixed(2)}</td>
          <td>${potentialMove !== "N/A" ? potentialMove.toFixed(2) + "%" : "N/A"}</td>
          <td>${predictionPrices.length}</td>
        `;
        // Clicking a row â†’ show the price target chart
        row.addEventListener("click", () => {
          if (currentPrice !== "N/A") {
            showCurrentPrice(ticker);
          }
          renderPriceTargetChart(ticker, predictionPrices, currentPrice);
        });

        predictionsBody.appendChild(row);
      });
    }

    function showCurrentPrice(ticker) {
      const price = stockPrices[ticker];
      document.getElementById("currentPriceDisplay").textContent =
        price !== undefined
          ? `Current Market Price: $${price.toFixed(2)}`
          : "Market price not available";
    }

    // 6) The price target number line
    function renderPriceTargetChart(ticker, predictions, currentPrice) {
      let minPrice = Math.min(...predictions);
      let maxPrice = Math.max(...predictions);
      let avgPrice = predictions.reduce((a, b) => a + b, 0) / predictions.length;

      // Avoid dividing by zero if min == max
      if (minPrice === maxPrice) {
        maxPrice = minPrice + 0.01;
      }

      function getPercentage(price) {
        let pct = ((price - minPrice) / (maxPrice - minPrice)) * 100;
        return Math.max(0, Math.min(100, pct));
      }

      const minPct = getPercentage(minPrice);
      const maxPct = getPercentage(maxPrice); // ~100%
      const avgPct = getPercentage(avgPrice);
      let currentPct = avgPct;
      if (currentPrice !== "N/A") {
        currentPct = getPercentage(currentPrice);
      }

      let chartContainer = document.getElementById("priceTargetChart");
      chartContainer.innerHTML = `
        <h4>${ticker} Price Targets</h4>
        <div class="number-line">
          <!-- Low -->
          <div class="marker" style="left: ${minPct}%;">
            $${minPrice.toFixed(2)} (Low)
          </div>
          <!-- Avg -->
          <div class="marker" style="left: ${avgPct}%;">
            $${avgPrice.toFixed(2)} (Avg)
          </div>
          <!-- High -->
          <div class="marker" style="left: ${maxPct}%;">
            $${maxPrice.toFixed(2)} (High)
          </div>
          <!-- Current -->
          ${
            currentPrice !== "N/A"
              ? `<div class="marker marker-current" style="left: ${currentPct}%;">
                   $${currentPrice.toFixed(2)} (Current)
                 </div>`
              : ""
          }
        </div>
      `;
    }
  </script>
</body>
</html>
