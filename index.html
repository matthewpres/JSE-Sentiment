<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSE Sentiment Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .chart-container {
            width: 600px;
            margin: 20px auto;
        }
        .number-line {
            width: 100%;
            height: 50px;
            position: relative;
            border-top: 2px solid black;
        }
        .marker {
            position: absolute;
            top: -10px;
            text-align: center;
            transform: translateX(-50%);
            font-size: 14px;
        }
    </style>
</head>
<body>

<h1>JSE Sentiment Analysis</h1>

<!-- Input for stock ticker -->
<input type="text" id="tickerInput" placeholder="Enter Stock Ticker (e.g. ECL)">
<input type="number" id="priceInput" placeholder="1-Year Price Prediction ($)">
<button id="submitPrediction">Submit Prediction</button>

<p id="errorMessage" style="color:red;"></p>
<p id="currentPriceDisplay" style="color:green;"></p>

<table border="1">
    <thead>
        <tr>
            <th>Ticker</th>
            <th>Current Price ($)</th>
            <th>Avg Prediction Price ($)</th>
            <th>Potential Upside/Downside (%)</th>
            <th>Prediction Count</th>
        </tr>
    </thead>
    <tbody id="predictionsBody"></tbody>
</table>

<div class="chart-container">
    <h3>Price Target Range</h3>
    <div id="priceTargetChart"></div>
</div>

<script>
// Fetch tickers and market prices
const tickersUrl = "https://raw.githubusercontent.com/matthewpres/JSE-Sentiment/main/tickers.json";
let stockPrices = {};
fetch(tickersUrl)
    .then(response => response.json())
    .then(data => {
        stockPrices = data;
        console.log("Stock Prices Loaded:", stockPrices);
        updateAutocomplete();
        renderPredictionTable();
    })
    .catch(error => console.error("Error loading tickers:", error));

// Update autocomplete
function updateAutocomplete() {
    let tickerInput = document.getElementById("tickerInput");
    let datalist = document.createElement("datalist");
    datalist.id = "tickerList";
    Object.keys(stockPrices).forEach(ticker => {
        let option = document.createElement("option");
        option.value = ticker;
        datalist.appendChild(option);
    });
    tickerInput.appendChild(datalist);
}

// Show market price when ticker is selected
function showCurrentPrice(ticker) {
    const price = stockPrices[ticker];
    document.getElementById("currentPriceDisplay").textContent =
        price !== undefined ? `Current Market Price: $${price.toFixed(2)}` : "Market price not available";
}

// Submit prediction
document.getElementById("submitPrediction").addEventListener("click", function () {
    const ticker = document.getElementById("tickerInput").value.toUpperCase();
    const predictionPrice = parseFloat(document.getElementById("priceInput").value);
    const errorMessageEl = document.getElementById("errorMessage");

    if (!ticker || isNaN(predictionPrice) || !(ticker in stockPrices)) {
        errorMessageEl.textContent = "Invalid ticker or missing price.";
        return;
    }

    console.log("Prediction added:", { ticker, predictionPrice });

    // Store prediction in localStorage
    let storedPredictions = JSON.parse(localStorage.getItem("predictions")) || {};
    if (!storedPredictions[ticker]) {
        storedPredictions[ticker] = [];
    }
    storedPredictions[ticker].push(predictionPrice);
    localStorage.setItem("predictions", JSON.stringify(storedPredictions));

    errorMessageEl.textContent = "Prediction submitted successfully!";
    errorMessageEl.style.color = "green";
    document.getElementById("tickerInput").value = "";
    document.getElementById("priceInput").value = "";

    renderPredictionTable();
});

// Render prediction table
function renderPredictionTable() {
    let predictionsData = JSON.parse(localStorage.getItem("predictions")) || {};
    let predictionsBody = document.getElementById("predictionsBody");
    predictionsBody.innerHTML = "";

    Object.keys(predictionsData).forEach(ticker => {
        let predictionPrices = predictionsData[ticker];
        let avgPredictionPrice = predictionPrices.reduce((a, b) => a + b, 0) / predictionPrices.length;
        let currentPrice = stockPrices[ticker] || "N/A";
        let potentialMove = currentPrice !== "N/A" ? ((avgPredictionPrice - currentPrice) / currentPrice) * 100 : "N/A";

        let row = document.createElement("tr");
        row.innerHTML = `
            <td>${ticker}</td>
            <td>${currentPrice !== "N/A" ? "$" + currentPrice.toFixed(2) : "N/A"}</td>
            <td>$${avgPredictionPrice.toFixed(2)}</td>
            <td>${potentialMove !== "N/A" ? potentialMove.toFixed(2) + "%" : "N/A"}</td>
            <td>${predictionPrices.length}</td>
        `;
        row.addEventListener("click", () => renderPriceTargetChart(ticker, predictionPrices, currentPrice));
        predictionsBody.appendChild(row);
    });
}

// Render price target number line
function renderPriceTargetChart(ticker, predictions, currentPrice) {
    let minPrice = Math.min(...predictions);
    let maxPrice = Math.max(...predictions);
    let avgPrice = predictions.reduce((a, b) => a + b, 0) / predictions.length;

    let chartContainer = document.getElementById("priceTargetChart");
    chartContainer.innerHTML = `
        <h4>${ticker} Price Targets</h4>
        <div class="number-line">
            <div class="marker" style="left: 5%;">$${minPrice} (Low)</div>
            <div class="marker" style="left: 50%; font-weight: bold;">$${avgPrice.toFixed(2)} (Avg)</div>
            <div class="marker" style="left: 95%;">$${maxPrice} (High)</div>
            <div class="marker" style="left: ${((currentPrice - minPrice) / (maxPrice - minPrice)) * 100}%; color: red;">$${currentPrice} (Current)</div>
        </div>
    `;
}
</script>
</body>
</html>
